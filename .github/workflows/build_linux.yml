name: Build Linux Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build on Ubuntu 22.04
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 

      - name: Free Disk Space (Aggressive Cleanup)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h # Shows us exactly how much space we reclaimed

      - name: Setup Python
        uses: actions/setup-python@v5  
        with:
          python-version: '3.10' 

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-cursor0 libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 \
            libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 \
            libnss3 libxcomposite1 libxcursor1 libasound2 \
            libegl1-mesa libgl1-mesa-glx

      - name: Install Python Dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          
          pip install -r requirements.txt
          
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          source venv/bin/activate
          pyinstaller --clean bookah_linux.spec

      - name: Prepare Distribution
        run: |
          cp install_and_run.sh dist/Bookah_Linux/
          chmod +x dist/Bookah_Linux/install_and_run.sh
          
          cd dist
          zip -r Bookah_Linux.zip Bookah_Linux

      - name: Upload Artifact
        uses: actions/upload-artifact@v4  
        with:
          name: Bookah_Linux_Build
          path: dist/Bookah_Linux.zip
