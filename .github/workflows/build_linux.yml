name: Build Linux Release

# Trigger manually (for testing) or when you push a tag like "v1.5"
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build on Ubuntu 22.04
    # We use 20.04 explicitly.
    # PRO TIP: Building on older Linux makes the binary compatible with
    # both old (20.04) and new (22.04, 24.04) systems.
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Install System Dependencies
        # This is the "Mega-List" we discovered in WSL.
        # We install it here so PyInstaller can find the libs during build.
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-cursor0 libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 \
            libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 \
            libnss3 libxcomposite1 libxcursor1 libasound2 \
            libegl1-mesa libgl1-mesa-glx

      - name: Install Python Dependencies
        # Tries to use requirements.txt, falls back to manual list if missing
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyinstaller PyQt6 PyQt6-WebEngine requests packaging

      - name: Build with PyInstaller
        # We clean previous builds and use the spec file we created
        run: |
          pyinstaller --clean bookah_linux.spec

      - name: Prepare Distribution
        # Inject the launcher script and set permissions
        run: |
          cp install_and_run.sh dist/Bookah_Linux/
          chmod +x dist/Bookah_Linux/install_and_run.sh
          
          # Zip it up exactly how we did manually
          cd dist
          zip -r Bookah_Linux.zip Bookah_Linux

      - name: Upload Artifact
        # This saves the zip so you can download it from the GitHub website
        uses: actions/upload-artifact@v3
        with:
          name: Bookah_Linux_Build
          path: dist/Bookah_Linux.zip